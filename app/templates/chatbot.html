{% extends 'base.html' %}

{% block content %}
<body class="bg-gradient-to-br from-gray-700 to-black text-white font-poppins">

    <!-- Chat Interface Wrapper -->
    <div class="min-h-screen flex items-center justify-center">
        <div class="w-[70%] max-w-3xl h-[75vh] bg-gradient-to-br from-gray-800 via-gray-700 to-gray-600 shadow-2xl rounded-3xl overflow-hidden flex flex-col text-white">

            <!-- Header Section -->
            <header class="bg-green-700 px-6 py-4 flex justify-between items-center">
                <h1 class="text-2xl font-bold tracking-wider">AnnadattaMitra AI</h1>
                <button id="call-btn" class="bg-green-500 hover:bg-green-600 p-3 rounded-full shadow-lg transition">
                    üìû Call Assistant
                </button>
            </header>

            <div class="bg-gray-800 p-2 flex justify-end border-t border-gray-700">
                <button id="lang-en" class="bg-gray-700 hover:bg-gray-600 text-white px-3 py-1 rounded-lg mx-2">English</button>
                <button id="lang-hi" class="bg-gray-700 hover:bg-gray-600 text-white px-3 py-1 rounded-lg mx-2">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</button>
                <button id="lang-tam" class="bg-gray-700 hover:bg-gray-600 text-white px-3 py-1 rounded-lg mx-2">Tamil lang</button>
                <button id="lang-tel" class="bg-gray-700 hover:bg-gray-600 text-white px-3 py-1 rounded-lg mx-2">Telugu lang</button>
                <button id="lang-mar" class="bg-gray-700 hover:bg-gray-600 text-white px-3 py-1 rounded-lg mx-2">‡§Æ‡§∞‡§æ‡§†‡•Ä lang</button>
            </div>

            <!-- Chat Messages Section -->
            <div id="chat-window" class="flex-1 p-6 space-y-4 overflow-y-auto custom-scroll">
                <div class="message bot-message flex items-start">
                    <img src="https://cdn-icons-png.flaticon.com/512/194/194938.png" class="avatar" alt="Bot" />
                    <div class="ml-4 px-4 py-3 bg-gray-800 rounded-2xl max-w-[75%]">
                        <p>Hello! I'm your farming assistant. üå± How can I assist you today?</p>
                    </div>
                </div>
            </div>

            <div class="bg-gray-800 p-4 border-t border-gray-700 flex items-center">
                <input 
                    type="text" 
                    id="user-input" 
                    class="w-full p-3 rounded-l-lg focus:outline-none bg-gray-700 text-white placeholder-gray-400" 
                    placeholder="Type your message..."
                    required 
                />
                <div>
                    <span id="microphoneButton" style="cursor: pointer; font-size: 36px;">üé§</span>
                </div>
                <button 
                    id="send-btn" 
                    class="bg-green-600 hover:bg-green-700 px-6 py-3 rounded-r-lg transition text-white font-bold">
                    Send
                </button>
            </div>
        </div>
    </div>

    <!-- Modal for Call Assistant -->
    <div id="call-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-gray-900 p-6 rounded-lg flex flex-col items-center">
            <h2 class="text-lg font-bold mb-4">Calling Assistant...</h2>
            <p id="call-status" class="mb-4">You are now connected to your farming assistant. How can I help you?</p>
            <div class="flex space-x-2">
                <button id="mute-user-btn" class="bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded text-white">üîä Mute User</button>
                <button id="mute-ai-btn" class="bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded text-white">üîä Mute AI</button>
            </div>
            <button id="hang-up-btn" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded text-white mt-4">Hang Up</button>
        </div>
    </div>

    <script>
        let selectedLanguage = 'English'; // Default language
        let isInCall = false; // Call status
        let isUserMuted = false; // User mute status
        let isAIMuted = false; // AI mute status
        let recognition; // Speech recognition instance
        const synth = window.speechSynthesis; // Speech synthesis instance

        // Language selection functionality
        document.querySelectorAll('[id^="lang-"]').forEach(button => {
            button.addEventListener('click', function() {
                selectedLanguage = button.textContent; // Update selected language
                appendMessage(`Language selected: ${selectedLanguage}`, 'bot'); // Append message to chat
            });
        });

        // Get recognition language based on selected language
        function getRecognitionLang(language) {
            switch (language) {
                case '‡§π‡§ø‡§®‡•ç‡§¶‡•Ä': return 'hi-IN';
                case 'Tamil': return 'ta-IN';
                case 'Telugu': return 'te-IN';
                case '‡§Æ‡§∞‡§æ‡§†‡•Ä': return 'mr-IN';
                default: return 'en-US';
            }
        }

        // Initialize Speech Recognition
        function initializeRecognition() {
            if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
                recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
                recognition.lang = getRecognitionLang(selectedLanguage);
                recognition.interimResults = false; // Only accept final results

                recognition.onstart = function () {
                    console.log('Voice recognition activated. Try speaking into the microphone.');
                };

                recognition.onresult = function (event) {
                    const result = event.results[0][0].transcript; // Get the spoken text
                    const isFinal = event.results[0].isFinal; // Check if the result is final

                    if (isFinal && isInCall && !isUserMuted) {
                        // appendMessage(result, 'user'); // Display user's message
                        sendMessage(result); // Process user's message
                        recognition.stop(); // Stop recognition after capturing the final result
                    }
                };

                recognition.onerror = function (event) {
                    console.error('Error occurred in recognition:', event.error);
                };

                recognition.onend = function () {
                    console.log('Voice recognition deactivated.');
                    if (isInCall && !isUserMuted) {
                        startListening(); // Restart listening if still in call and not muted
                    }
                };
            } else {
                alert('Speech recognition is not supported in this browser.');
            }
        }

        // Speak function to convert text to speech
        function speak(text) {
            if (!isAIMuted) { // Check AI mute status
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = getRecognitionLang(selectedLanguage);
                synth.speak(utterance); // Speak the text only if not muted
            }
        }

        // Start Listening for User Input
        function startListening() {
            if (recognition && !isUserMuted) {
                recognition.start(); // Start speech recognition if not muted
            }
        }

        const chatWindow = document.getElementById('chat-window');
        const userInput = document.getElementById('user-input');

        // Scroll to bottom helper function
        function scrollToBottom() {
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        // Add a new chat message (either bot or user)
        function appendMessage(content, sender = 'user') {
            const message = document.createElement('div');
            message.classList.add('message', '${sender}-message', 'flex', 'items-start', 'mb-4');

            if (sender === 'bot') {
                message.innerHTML = `
                    <img src="https://cdn-icons-png.flaticon.com/512/194/194938.png" class="avatar" alt="Bot" />
                    <div class="ml-4 px-4 py-3 bg-gray-800 rounded-2xl max-w-[75%]">
                        <p>${content}</p>
                    </div>
                `;
            } else {
                message.innerHTML = `
                    <div class="ml-auto px-4 py-3 bg-green-700 rounded-2xl max-w-[75%]">
                        <p>${content}</p>
                    </div>
                `;
            }

            chatWindow.appendChild(message);
            scrollToBottom();
        }

        // Send User Message
        function sendMessage(userMessage) {
            if (userMessage) {
                const messageWithLanguage = `[${selectedLanguage}] ${userMessage}`;

                appendMessage(messageWithLanguage, 'user');  

                // AJAX request to send message to Django backend
                fetch('/chat_api/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken'),  
                    },
                    body: JSON.stringify({ message: messageWithLanguage }), 
                })
                .then(response => response.json())
                .then(data => {
                    if (data.response) {
                        appendMessage(data.response, 'bot');  
                        speak(data.response); // Speak the bot's response
                    } else if (data.error) {
                        appendMessage('Error: ${data.error}', 'bot');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    appendMessage('Error: Unable to connect to the server.', 'bot');
                });
            }
        }

        // Helper function to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Handle Enter Key for Sending Message
        userInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault(); 
                const userMessage = userInput.value.trim();
                if (userMessage) {
                    sendMessage(userMessage); // Send the message
                    userInput.value = ''; // Clear input field
                }
            }
        });

        // Handle Send Button Click
        document.getElementById('send-btn').addEventListener('click', () => {
            const userMessage = userInput.value.trim();
            if (userMessage) {
                sendMessage(userMessage); // Send the message
                userInput.value = ''; // Clear input field
            }
        });

        // Handle Microphone Click
        let isListening = false;

        // Check for Speech Recognition support
        if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
            recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.continuous = false; // Not continuously listening
            recognition.interimResults = false; // No interim results

            recognition.onresult = function(event) {
                const result = event.results[0][0].transcript;
                document.getElementById('user-input').value = result; // Set the input field to the recognized text
                recognition.stop(); // Stop recognition after getting the result
            };

            recognition.onerror = function(event) {
                console.error('Recognition error:', event.error);
                isListening = false; // Reset listening status
            };

            recognition.onend = function() {
                isListening = false; // Reset listening status when recognition ends
            };

            document.getElementById('microphoneButton').addEventListener('click', (event) => {
                event.preventDefault(); // Prevent default action
                if (!isListening) {
                    isListening = true; // Set listening status
                    recognition.start(); // Start speech recognition
                }
            });
        } else {
            alert('Speech recognition is not supported in this browser.');
        }

        // Handle call button click
        document.getElementById('call-btn').addEventListener('click', () => {
            isInCall = true; // Update call status
            document.getElementById('call-modal').classList.remove('hidden');
            appendMessage("Call started. You can use Hindi, English, or Marathi.", 'bot'); // Inform the user the call has started
            speak("Call started. You can use Hindi, English, or Marathi."); // Speak the call start
            initializeRecognition(); // Initialize speech recognition
            startListening(); // Start listening for user input
        });
        

        // Handle hang up button click
        document.getElementById('hang-up-btn').addEventListener('click', () => {
            isInCall = false; // Update call status
            document.getElementById('call-modal').classList.add('hidden');
            if (recognition) {
                recognition.stop(); // Stop recognition
            }
            appendMessage("Call ended.", 'bot'); // Inform the user the call has ended
        });

        // Handle mute user button click
        document.getElementById('mute-user-btn').addEventListener('click', () => {
            isUserMuted = !isUserMuted; // Toggle user mute status
            const muteButton = document.getElementById('mute-user-btn');
            muteButton.textContent = isUserMuted ? 'üîä Unmute User' : 'üîä Mute User'; // Update button text
            if (isUserMuted) {
                if (recognition) {
                    recognition.stop(); // Stop listening if muted
                }
            } else {
                startListening(); // Restart listening if unmuted
            }
        });

        // Handle mute AI button click
        document.getElementById('mute-ai-btn').addEventListener('click', () => {
            isAIMuted = !isAIMuted; // Toggle AI mute status
            const muteButton = document.getElementById('mute-ai-btn');
            muteButton.textContent = isAIMuted ? 'üîä Unmute AI' : 'üîä Mute AI'; // Update button text
            if (isAIMuted) {
                synth.cancel(); // Stop speaking if currently speaking
            }
        });
    </script>

    <style>
        /* Custom Scrollbar Styling */
        .custom-scroll::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 10px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: #1f2937;
        }

        /* Avatar Styling */
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }

        /* Chat Bubble Animations */
        .bot-message {
            animation: fadeInLeft 0.5s ease-out;
        }
        .user-message {
            animation: fadeInRight 0.5s ease-out;
        }

        /* Animations for Message Bubbles */
        @keyframes fadeInLeft {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes fadeInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
    </style>

</body>
{% endblock content %}